"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createProxyHandler = void 0;

var _httpProxyMiddleware = require("http-proxy-middleware");

var _utils = require("@modern-js/utils");

var _utils2 = require("../utils");

const createProxyHandler = proxyOptions => {
  (0, _utils2.debug)('createProxyHandler', proxyOptions);

  if (!proxyOptions) {
    return null;
  } // If it is not an array, it may be an object that uses the context attribute
  // or an object in the form of { source: ProxyDetail }


  const formattedProxy = (0, _utils.formatProxyOptions)(proxyOptions);
  const middlewares = formattedProxy.map(option => {
    const middleware = (0, _httpProxyMiddleware.createProxyMiddleware)(option.context, option); // eslint-disable-next-line consistent-return

    return async (ctx, next) => {
      const {
        req,
        res
      } = ctx;
      const bypassUrl = typeof option.bypass === 'function' ? option.bypass(req, res, option) : null; // only false, no true

      if (typeof bypassUrl === 'boolean') {
        ctx.status = 404;
        return next();
      } else if (typeof bypassUrl === 'string') {
        ctx.url = bypassUrl;
        return next();
      }

      middleware(req, res, next);
    };
  });
  return middlewares;
};

exports.createProxyHandler = createProxyHandler;