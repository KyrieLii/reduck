"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _path = _interopRequireDefault(require("path"));

var _utils = require("@modern-js/utils");

var _cli = _interopRequireDefault(require("@modern-js/plugin-state/cli"));

var _cli2 = _interopRequireDefault(require("@modern-js/plugin-router/cli"));

var _cli3 = _interopRequireDefault(require("@modern-js/plugin-ssr/cli"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _default = () => ({
  name: '@modern-js/runtime',
  post: ['@modern-js/plugin-router', '@modern-js/plugin-ssr', '@modern-js/plugin-state', '@modern-js/plugin-design-token'],
  usePlugins: [(0, _cli.default)(), (0, _cli2.default)(), (0, _cli3.default)()],
  setup: api => {
    let runtimeExportsUtils = {};
    return {
      config() {
        const dir = api.useAppContext().internalDirectory;
        runtimeExportsUtils = (0, _utils.createRuntimeExportsUtils)(dir, 'index');
        return {
          runtime: {},
          runtimeByEntries: {},
          source: {
            alias: {
              '@modern-js/runtime$': runtimeExportsUtils.getPath()
            }
          }
        };
      },

      validateSchema() {
        return _utils.PLUGIN_SCHEMAS['@modern-js/runtime'];
      },

      addRuntimeExports() {
        const runtimePackage = _path.default.resolve(__dirname, '../../../../');

        runtimeExportsUtils.addExport(`export * from '${runtimePackage}'`);
      },

      async beforeRestart() {
        (0, _utils.cleanRequireCache)([require.resolve('@modern-js/plugin-state/cli'), require.resolve('@modern-js/plugin-router/cli'), require.resolve('@modern-js/plugin-ssr/cli')]);
      }

    };
  }
});

exports.default = _default;